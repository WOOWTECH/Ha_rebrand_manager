---
name: Component Unit Tests
status: closed
created: 2026-02-02T10:02:04Z
updated: 2026-02-02T10:20:03Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: true
conflicts_with: []
---

# Task 005: Component Unit Tests

## Description

Implement comprehensive unit tests for the Ha Rebrand Manager component's core functionality including config flow, component lifecycle (setup/unload), HTTP endpoints, and WebSocket commands. These tests validate the integration layer between the component and Home Assistant.

## Acceptance Criteria

- [ ] Config flow tests cover all user input scenarios
- [ ] Component lifecycle tests verify proper setup and teardown
- [ ] HTTP endpoint tests validate request handling and responses
- [ ] WebSocket command tests verify real-time communication
- [ ] All tests use proper Home Assistant test utilities
- [ ] Test coverage for component functions reaches 90%+

## Technical Details

### Test Config Flow (test_config_flow.py)

```python
# tests/unit/test_config_flow.py

class TestConfigFlow:
    """Test the config flow for Ha Rebrand Manager."""

    async def test_form_shows_on_init(self, hass):
        """Test that the form is shown on initialization."""
        result = await hass.config_entries.flow.async_init(
            DOMAIN, context={"source": config_entries.SOURCE_USER}
        )
        assert result["type"] == FlowResultType.FORM
        assert result["step_id"] == "user"

    async def test_create_entry_with_valid_data(self, hass):
        """Test creating an entry with valid configuration."""
        result = await hass.config_entries.flow.async_init(
            DOMAIN,
            context={"source": config_entries.SOURCE_USER},
            data={
                "title": "My Rebrand",
                "primary_color": "#3498db",
                "accent_color": "#e74c3c",
            }
        )
        assert result["type"] == FlowResultType.CREATE_ENTRY
        assert result["title"] == "My Rebrand"
        assert result["data"]["primary_color"] == "#3498db"

    async def test_reject_invalid_colors(self, hass):
        """Test that invalid colors are rejected."""
        result = await hass.config_entries.flow.async_init(
            DOMAIN,
            context={"source": config_entries.SOURCE_USER},
            data={
                "title": "Test",
                "primary_color": "invalid_color",
            }
        )
        assert result["type"] == FlowResultType.FORM
        assert "primary_color" in result["errors"]

    async def test_options_flow(self, hass, config_entry):
        """Test the options flow for updating configuration."""
        result = await hass.config_entries.options.async_init(
            config_entry.entry_id
        )
        assert result["type"] == FlowResultType.FORM
```

### Test Component Lifecycle

```python
# tests/unit/test_init.py

class TestComponentLifecycle:
    """Test component setup and teardown."""

    async def test_async_setup_creates_services(self, hass, config_entry):
        """Test that async_setup registers all services."""
        await async_setup_entry(hass, config_entry)

        assert hass.services.has_service(DOMAIN, "apply_theme")
        assert hass.services.has_service(DOMAIN, "reset_theme")
        assert hass.services.has_service(DOMAIN, "upload_logo")

    async def test_async_setup_entry_registers_http(self, hass, config_entry):
        """Test that HTTP endpoints are registered on setup."""
        await async_setup_entry(hass, config_entry)

        # Verify HTTP view is registered
        assert any(
            view.url == f"/api/{DOMAIN}/logo"
            for view in hass.http.app.router.routes()
        )

    async def test_async_unload_entry_cleanup(self, hass, config_entry):
        """Test that unload properly cleans up resources."""
        await async_setup_entry(hass, config_entry)
        result = await async_unload_entry(hass, config_entry)

        assert result is True
        assert not hass.services.has_service(DOMAIN, "apply_theme")

    async def test_reload_entry(self, hass, config_entry):
        """Test that reloading entry works correctly."""
        await async_setup_entry(hass, config_entry)
        await hass.config_entries.async_reload(config_entry.entry_id)

        # Services should still be available after reload
        assert hass.services.has_service(DOMAIN, "apply_theme")
```

### Test HTTP Endpoints

```python
# tests/unit/test_http.py

class TestHTTPEndpoints:
    """Test HTTP endpoint handlers."""

    async def test_get_logo_returns_image(self, hass, hass_client, config_entry):
        """Test that GET /api/ha_rebrand_manager/logo returns the logo."""
        await async_setup_entry(hass, config_entry)
        client = await hass_client()

        resp = await client.get(f"/api/{DOMAIN}/logo")
        assert resp.status == 200
        assert resp.content_type.startswith("image/")

    async def test_get_logo_404_when_missing(self, hass, hass_client):
        """Test that 404 is returned when no logo is configured."""
        client = await hass_client()

        resp = await client.get(f"/api/{DOMAIN}/logo")
        assert resp.status == 404

    async def test_post_logo_requires_auth(self, hass, hass_client):
        """Test that uploading logo requires authentication."""
        client = await hass_client()

        resp = await client.post(
            f"/api/{DOMAIN}/logo",
            data={"file": b"fake_image"},
        )
        assert resp.status == 401

    async def test_post_logo_validates_file(self, hass, hass_client_auth):
        """Test that uploaded files are validated."""
        client = await hass_client_auth()

        resp = await client.post(
            f"/api/{DOMAIN}/logo",
            data={"file": (b"not_an_image", "test.png")},
        )
        assert resp.status == 400
```

### Test WebSocket Commands

```python
# tests/unit/test_websocket.py

class TestWebSocketCommands:
    """Test WebSocket command handlers."""

    async def test_get_config_command(self, hass, websocket_client, config_entry):
        """Test retrieving configuration via WebSocket."""
        await async_setup_entry(hass, config_entry)

        await websocket_client.send_json({
            "id": 1,
            "type": f"{DOMAIN}/get_config",
        })

        response = await websocket_client.receive_json()
        assert response["success"] is True
        assert "config" in response["result"]

    async def test_apply_theme_command(self, hass, websocket_client, config_entry):
        """Test applying theme via WebSocket."""
        await async_setup_entry(hass, config_entry)

        await websocket_client.send_json({
            "id": 2,
            "type": f"{DOMAIN}/apply_theme",
            "primary_color": "#ff0000",
        })

        response = await websocket_client.receive_json()
        assert response["success"] is True

    async def test_invalid_command_rejected(self, hass, websocket_client):
        """Test that invalid commands are rejected."""
        await websocket_client.send_json({
            "id": 3,
            "type": f"{DOMAIN}/invalid_command",
        })

        response = await websocket_client.receive_json()
        assert response["success"] is False
```

## Dependencies

- **Task 003**: Test fixtures and conftest.py must be created first
- **pytest-homeassistant-custom-component**: HA testing utilities
- **pytest-aiohttp**: HTTP client testing

## Effort Estimate

- **Estimated Time**: 4-6 hours
- **Complexity**: Medium-High
- **Risk Level**: Medium (depends on HA testing utilities)

## Definition of Done

1. All test files are created in `tests/unit/` directory
2. Config flow tests cover user flow, options flow, and error handling
3. Lifecycle tests verify setup, unload, and reload
4. HTTP tests cover all endpoints with auth scenarios
5. WebSocket tests cover all registered commands
6. All tests pass with `pytest tests/unit/ -v`
7. Test coverage reaches 90%+ for component code
8. Tests are documented with clear descriptions
9. Code review completed
