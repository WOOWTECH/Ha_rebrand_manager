---
name: Unit Test Fixtures
status: closed
created: 2026-02-02T10:02:04Z
updated: 2026-02-02T10:11:44Z
github:
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task 003: Unit Test Fixtures

## Description

Create the test infrastructure including directory structure, pytest configuration, and reusable fixtures. This task establishes the foundation for all unit, integration, and security tests that follow.

## Acceptance Criteria

- [ ] `tests/` directory structure is created
- [ ] `tests/conftest.py` contains Home Assistant mock fixtures
- [ ] Test data fixtures for XSS payloads are available
- [ ] Sample configuration fixtures are defined
- [ ] `pytest tests/` runs successfully (even with no tests yet)
- [ ] Fixtures are importable from any test module

## Technical Details

### Directory Structure

```
tests/
├── __init__.py
├── conftest.py              # Shared fixtures
├── fixtures/
│   ├── __init__.py
│   ├── xss_payloads.py      # XSS test vectors
│   └── sample_configs.py    # Test configurations
├── unit/
│   └── __init__.py
├── integration/
│   └── __init__.py
└── e2e/
    └── __init__.py
```

### conftest.py Fixtures

```python
import pytest
from pytest_homeassistant_custom_component.common import MockConfigEntry
from homeassistant.core import HomeAssistant

@pytest.fixture
def hass(hass: HomeAssistant) -> HomeAssistant:
    """Return Home Assistant instance."""
    return hass

@pytest.fixture
def mock_config_entry() -> MockConfigEntry:
    """Create a mock config entry."""
    return MockConfigEntry(
        domain="ha_rebrand",
        data={...},
        unique_id="test_unique_id",
    )

@pytest.fixture
def mock_coordinator(hass: HomeAssistant):
    """Create a mock coordinator."""
    ...
```

### XSS Payload Fixtures

```python
# tests/fixtures/xss_payloads.py

XSS_PAYLOADS = [
    "<script>alert('xss')</script>",
    "<img src=x onerror=alert('xss')>",
    "javascript:alert('xss')",
    "<svg onload=alert('xss')>",
    "{{constructor.constructor('alert(1)')()}}",
    # ... comprehensive list
]

SAFE_STRINGS = [
    "Normal text",
    "Text with <escaped> brackets",
    "Unicode: \u4e2d\u6587",
    # ... edge cases
]
```

### Sample Config Fixtures

```python
# tests/fixtures/sample_configs.py

VALID_CONFIGS = [
    {"host": "localhost", "port": 8123, ...},
    # ... various valid configurations
]

INVALID_CONFIGS = [
    {"host": "", ...},  # Empty host
    {"port": -1, ...},  # Invalid port
    # ... edge cases
]
```

### pytest.ini Configuration

Add to `pyproject.toml`:

```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "auto"
filterwarnings = [
    "ignore::DeprecationWarning",
]
```

## Dependencies

- **001** (Project Setup): Requires pytest and pytest-homeassistant-custom-component

This task is NOT parallel because it creates the foundation that other test tasks will use.

## Effort Estimate

**Size:** Medium (2-3 hours)
**Complexity:** Medium
**Risk:** Low

## Definition of Done

1. `tests/` directory structure exists as specified
2. `conftest.py` is created with at least 3 core fixtures
3. XSS payload fixtures contain at least 10 test vectors
4. Sample config fixtures cover valid and invalid cases
5. `pytest tests/ --collect-only` shows fixtures are discoverable
6. `pytest tests/` exits with code 0 (no collection errors)
7. Documentation comments explain fixture usage
