---
name: E2E Sidebar and Text Replacement Tests
status: closed
created: 2026-02-02T10:02:04Z
updated: 2026-02-02T10:18:22Z
github:
depends_on: [006]
parallel: true
conflicts_with: []
---

# Task 008: E2E Sidebar and Text Replacement Tests

## Description

Create end-to-end tests for sidebar branding customization and text replacement functionality. These tests verify that the sidebar displays custom logos and titles correctly, handles theme switching (dark/light mode), and that configured text replacement rules are applied throughout the Home Assistant interface.

## Acceptance Criteria

- [ ] Sidebar tests verify custom logo display
- [ ] Sidebar tests verify custom title change
- [ ] Sidebar tests verify branding persists through dark mode toggle
- [ ] Sidebar tests verify branding persists through light mode toggle
- [ ] Text replacement tests can configure replacement rules
- [ ] Text replacement tests verify text is replaced on dashboard
- [ ] Text replacement tests verify text is replaced on settings pages
- [ ] Text replacement tests verify text is replaced on entity cards
- [ ] All tests handle async UI updates properly
- [ ] Tests include visual regression checks where appropriate

## Technical Details

### Sidebar Branding Tests (`tests/e2e/test_sidebar_branding.py`)

```python
# Test scenarios:
# 1. Verify custom logo in sidebar header
# 2. Verify custom title text in sidebar
# 3. Toggle dark mode and verify branding persists
# 4. Toggle light mode and verify branding persists
# 5. Verify logo scales correctly on sidebar collapse/expand
# 6. Test sidebar on mobile viewport

async def test_sidebar_custom_logo(authenticated_page):
    """Verify custom logo is displayed in sidebar."""
    sidebar = authenticated_page.locator("ha-sidebar")
    logo = sidebar.locator("[data-testid='sidebar-logo']")
    await expect(logo).to_be_visible()
    src = await logo.get_attribute("src")
    assert "custom" in src or "rebrand" in src

async def test_dark_mode_branding(authenticated_page):
    """Verify branding persists in dark mode."""
    # Open user menu
    await authenticated_page.click("[data-testid='user-menu']")
    # Toggle dark mode
    await authenticated_page.click("text=Dark mode")
    # Wait for theme transition
    await authenticated_page.wait_for_timeout(500)
    # Verify logo still visible
    logo = authenticated_page.locator("[data-testid='sidebar-logo']")
    await expect(logo).to_be_visible()
```

### Text Replacement Tests (`tests/e2e/test_text_replacement.py`)

```python
# Test scenarios:
# 1. Configure text replacement rule (e.g., "Home Assistant" -> "My Home")
# 2. Verify replacement on main dashboard title
# 3. Verify replacement in sidebar
# 4. Verify replacement in settings pages
# 5. Verify replacement in entity names/cards
# 6. Test multiple replacement rules
# 7. Test rule priority/ordering
# 8. Test special characters in replacements

async def test_text_replacement_dashboard(authenticated_page, rebrand_config):
    """Verify text replacement on dashboard."""
    # Configure replacement: "Home Assistant" -> "Smart Home"
    await rebrand_config.add_text_rule("Home Assistant", "Smart Home")
    await rebrand_config.apply()

    # Refresh to apply changes
    await authenticated_page.reload()

    # Verify text is replaced
    content = await authenticated_page.content()
    assert "Smart Home" in content
    assert "Home Assistant" not in content  # Original text should be gone

async def test_multiple_replacement_rules(authenticated_page, rebrand_config):
    """Verify multiple replacement rules work together."""
    await rebrand_config.add_text_rule("Home Assistant", "My Home")
    await rebrand_config.add_text_rule("Dashboard", "Control Center")
    await rebrand_config.add_text_rule("Settings", "Configuration")
    await rebrand_config.apply()

    await authenticated_page.reload()

    # Verify all replacements
    await expect(authenticated_page.locator("text=My Home")).to_be_visible()
    await expect(authenticated_page.locator("text=Control Center")).to_be_visible()
```

### Page Objects

```python
# pages/sidebar.py
class Sidebar:
    def __init__(self, page):
        self.page = page
        self.root = page.locator("ha-sidebar")

    async def get_logo(self):
        return self.root.locator("[data-testid='sidebar-logo']")

    async def get_title(self):
        return self.root.locator(".title")

    async def toggle_collapse(self):
        await self.root.locator("[data-testid='collapse-button']").click()

# pages/theme_switcher.py
class ThemeSwitcher:
    def __init__(self, page):
        self.page = page

    async def set_dark_mode(self):
        await self._open_user_menu()
        await self.page.click("[data-testid='dark-mode-toggle']")

    async def set_light_mode(self):
        await self._open_user_menu()
        await self.page.click("[data-testid='light-mode-toggle']")
```

### Test Data

```python
TEXT_REPLACEMENT_RULES = [
    {"original": "Home Assistant", "replacement": "My Smart Home"},
    {"original": "Dashboard", "replacement": "Home View"},
    {"original": "Automation", "replacement": "Smart Rules"},
    {"original": "Settings", "replacement": "Configure"},
]

SPECIAL_CHAR_RULES = [
    {"original": "Temperature", "replacement": "Temp."},
    {"original": "Living Room", "replacement": "Living Rm"},
    {"original": "&", "replacement": "and"},
]
```

### Visual Regression

```python
@pytest.mark.visual
async def test_sidebar_visual_regression(authenticated_page, snapshot):
    """Compare sidebar appearance against baseline."""
    sidebar = authenticated_page.locator("ha-sidebar")
    await expect(sidebar).to_have_screenshot("sidebar-branded.png")

@pytest.mark.visual
async def test_sidebar_dark_mode_visual(authenticated_page, snapshot):
    """Compare dark mode sidebar against baseline."""
    await ThemeSwitcher(authenticated_page).set_dark_mode()
    sidebar = authenticated_page.locator("ha-sidebar")
    await expect(sidebar).to_have_screenshot("sidebar-branded-dark.png")
```

## Dependencies

- **Task 006**: Test fixtures and utilities must be in place
- Playwright visual comparison capabilities
- Access to theme toggle functionality in HA

## Effort Estimate

- **Estimated Hours**: 6-8 hours
- **Complexity**: Medium-High
- **Risk**: Medium (UI selectors may vary by HA version)

## Definition of Done

1. All sidebar branding tests implemented and passing
2. All text replacement tests implemented and passing
3. Dark/light mode switching tests passing
4. Visual regression baselines established
5. Page objects documented and reusable
6. Tests handle HA UI loading states properly
7. No race conditions or flaky tests
8. Tests complete in under 90 seconds total
9. Code reviewed and merged to test branch
