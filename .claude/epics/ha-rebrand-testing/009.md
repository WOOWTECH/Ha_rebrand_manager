---
name: CI Workflow
status: closed
created: 2026-02-02T10:02:04Z
updated: 2026-02-02T10:21:40Z
github:
depends_on: [002, 004, 005, 007, 008]
parallel: false
conflicts_with: []
---

# Task 009: CI Workflow

## Description

Create a comprehensive GitHub Actions CI workflow that runs static analysis, unit tests with coverage reporting, and optionally executes E2E tests when a Home Assistant instance is available. This workflow ensures code quality and test coverage are maintained on every push and pull request.

## Acceptance Criteria

- [ ] CI workflow file created at `.github/workflows/test.yml`
- [ ] Static analysis runs ruff for linting
- [ ] Static analysis runs mypy for type checking
- [ ] Unit tests run with pytest and generate coverage report
- [ ] Coverage report uploaded to codecov or similar service
- [ ] E2E tests run conditionally when HA instance is available
- [ ] Workflow runs on push to main and all pull requests
- [ ] Workflow uses caching for dependencies
- [ ] Workflow completes in under 10 minutes
- [ ] Clear job separation and status reporting

## Technical Details

### Workflow File (`.github/workflows/test.yml`)

```yaml
name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"

jobs:
  lint:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run ruff
        run: ruff check . --output-format=github

      - name: Run ruff format check
        run: ruff format --check .

      - name: Run mypy
        run: mypy custom_components/ha_rebrand_manager --ignore-missing-imports

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run unit tests with coverage
        run: |
          pytest tests/unit \
            --cov=custom_components/ha_rebrand_manager \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run integration tests
        run: |
          pytest tests/integration -v --tb=short

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install Playwright browsers
        run: playwright install chromium --with-deps

      - name: Start Home Assistant container
        run: |
          docker run -d \
            --name homeassistant \
            -p 8123:8123 \
            -v $(pwd)/custom_components:/config/custom_components \
            ghcr.io/home-assistant/home-assistant:stable

          # Wait for HA to start
          timeout 120 bash -c 'until curl -s http://localhost:8123 > /dev/null; do sleep 5; done'

      - name: Run E2E tests
        run: |
          pytest tests/e2e \
            --base-url=http://localhost:8123 \
            -v \
            --tb=short
        env:
          HA_URL: http://localhost:8123

      - name: Upload E2E test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            tests/e2e/screenshots/
            tests/e2e/videos/

      - name: Stop Home Assistant
        if: always()
        run: docker stop homeassistant && docker rm homeassistant

  all-tests-pass:
    name: All Tests Pass
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
          echo "All required tests passed!"
```

### Additional Configuration Files

#### `pyproject.toml` (ruff and mypy config)

```toml
[tool.ruff]
target-version = "py311"
line-length = 88
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
    "B",   # flake8-bugbear
    "C4",  # flake8-comprehensions
    "UP",  # pyupgrade
]
ignore = [
    "E501",  # line too long (handled by formatter)
]

[tool.ruff.isort]
known-first-party = ["custom_components.ha_rebrand_manager"]

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_ignores = true
disallow_untyped_defs = true
```

#### `requirements-dev.txt`

```text
pytest>=7.4.0
pytest-cov>=4.1.0
pytest-asyncio>=0.21.0
pytest-homeassistant-custom-component>=0.13.0
pytest-playwright>=0.4.0
playwright>=1.40.0
ruff>=0.1.0
mypy>=1.7.0
coverage[toml]>=7.3.0
```

### Workflow Features

1. **Dependency Caching**: Uses pip cache to speed up installs
2. **Parallel Jobs**: Lint and unit tests run in parallel
3. **Conditional E2E**: Only runs on main branch pushes
4. **Artifact Upload**: Coverage reports and failure screenshots saved
5. **Status Check**: Final job aggregates all results

### Branch Protection Rules (Recommended)

```yaml
# Configure in GitHub repository settings:
# Settings > Branches > Branch protection rules

Required status checks:
  - "Static Analysis"
  - "Unit Tests"
  - "Integration Tests"
  - "All Tests Pass"
```

## Dependencies

- **Task 002**: Ruff configuration and linting setup
- **Task 004**: Integration tests must exist
- **Task 005**: Unit tests must exist
- **Task 007**: E2E login/admin tests
- **Task 008**: E2E sidebar/text tests

## Effort Estimate

- **Estimated Hours**: 4-6 hours
- **Complexity**: Medium
- **Risk**: Low (standard CI patterns)

## Definition of Done

1. Workflow file created and committed
2. All jobs run successfully on test push
3. Coverage reporting integrated with Codecov
4. E2E tests run successfully in CI environment
5. Workflow completes in under 10 minutes
6. Branch protection rules documented
7. README updated with CI badge
8. All team members can trigger workflow
9. Failure notifications configured (optional)
10. Code reviewed and merged to main
