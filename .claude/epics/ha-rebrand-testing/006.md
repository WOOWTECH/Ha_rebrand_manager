---
name: E2E Infrastructure
status: open
created: 2026-02-02T10:02:04Z
updated: 2026-02-02T10:02:04Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task 006: E2E Infrastructure

## Description

Establish the end-to-end (E2E) testing infrastructure using Playwright for browser-based testing of the Ha Rebrand Manager component. This task creates the foundational directory structure, pytest fixtures for browser automation, and Page Object Model (POM) classes to enable maintainable E2E tests.

## Acceptance Criteria

- [ ] E2E directory structure created under `tests/e2e/`
- [ ] Playwright conftest.py with browser fixtures implemented
- [ ] Page Object Model classes created for LoginPage, AdminPanel, and Sidebar
- [ ] Basic smoke test verifies infrastructure works
- [ ] Documentation for running E2E tests included
- [ ] CI configuration for E2E test execution prepared

## Technical Details

### Create Directory Structure

```
tests/
└── e2e/
    ├── __init__.py
    ├── conftest.py              # Playwright fixtures
    ├── pages/                   # Page Object Models
    │   ├── __init__.py
    │   ├── base_page.py         # Base class for all pages
    │   ├── login_page.py        # Login page interactions
    │   ├── admin_panel.py       # Admin panel navigation
    │   └── sidebar.py           # Sidebar component
    ├── test_smoke.py            # Basic infrastructure tests
    └── fixtures/                # Test data files
        ├── test_logo.png
        └── test_config.json
```

### Create Playwright conftest.py

```python
# tests/e2e/conftest.py

import pytest
from playwright.async_api import async_playwright, Browser, Page, BrowserContext
from typing import AsyncGenerator
import os

# Configuration
HA_URL = os.getenv("HA_URL", "http://localhost:8123")
HA_USERNAME = os.getenv("HA_USERNAME", "admin")
HA_PASSWORD = os.getenv("HA_PASSWORD", "admin")


@pytest.fixture(scope="session")
def event_loop():
    """Create event loop for async tests."""
    import asyncio
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()


@pytest.fixture(scope="session")
async def browser() -> AsyncGenerator[Browser, None]:
    """Create browser instance for all tests."""
    async with async_playwright() as p:
        browser = await p.chromium.launch(
            headless=os.getenv("HEADLESS", "true").lower() == "true",
            slow_mo=int(os.getenv("SLOW_MO", "0")),
        )
        yield browser
        await browser.close()


@pytest.fixture(scope="function")
async def context(browser: Browser) -> AsyncGenerator[BrowserContext, None]:
    """Create isolated browser context for each test."""
    context = await browser.new_context(
        viewport={"width": 1280, "height": 720},
        locale="en-US",
        timezone_id="America/New_York",
    )
    yield context
    await context.close()


@pytest.fixture(scope="function")
async def page(context: BrowserContext) -> AsyncGenerator[Page, None]:
    """Create page for each test."""
    page = await context.new_page()
    yield page
    await page.close()


@pytest.fixture(scope="function")
async def authenticated_page(page: Page) -> Page:
    """Create authenticated page with logged-in user."""
    from pages.login_page import LoginPage

    login_page = LoginPage(page)
    await login_page.navigate()
    await login_page.login(HA_USERNAME, HA_PASSWORD)
    await login_page.wait_for_dashboard()
    return page


@pytest.fixture(scope="session")
async def authenticated_context(browser: Browser) -> AsyncGenerator[BrowserContext, None]:
    """Create context with stored authentication state."""
    context = await browser.new_context()
    page = await context.new_page()

    from pages.login_page import LoginPage
    login_page = LoginPage(page)
    await login_page.navigate()
    await login_page.login(HA_USERNAME, HA_PASSWORD)
    await login_page.wait_for_dashboard()

    # Store authentication state
    storage_state = await context.storage_state()
    await page.close()
    await context.close()

    # Create new context with stored state
    auth_context = await browser.new_context(storage_state=storage_state)
    yield auth_context
    await auth_context.close()
```

### Create Page Object Model Classes

#### Base Page

```python
# tests/e2e/pages/base_page.py

from playwright.async_api import Page, expect
from typing import Optional


class BasePage:
    """Base class for all Page Object Models."""

    def __init__(self, page: Page):
        self.page = page
        self.timeout = 30000  # 30 seconds default timeout

    async def navigate(self, path: str = "/") -> None:
        """Navigate to a path relative to HA base URL."""
        from ..conftest import HA_URL
        await self.page.goto(f"{HA_URL}{path}")

    async def wait_for_load(self) -> None:
        """Wait for page to finish loading."""
        await self.page.wait_for_load_state("networkidle")

    async def take_screenshot(self, name: str) -> bytes:
        """Take screenshot for debugging."""
        return await self.page.screenshot(path=f"screenshots/{name}.png")

    async def get_toast_message(self) -> Optional[str]:
        """Get toast notification message if present."""
        toast = self.page.locator(".toast-message, .notification")
        if await toast.count() > 0:
            return await toast.first.text_content()
        return None
```

#### Login Page

```python
# tests/e2e/pages/login_page.py

from playwright.async_api import Page, expect
from .base_page import BasePage


class LoginPage(BasePage):
    """Page Object for Home Assistant login page."""

    # Selectors
    USERNAME_INPUT = 'input[name="username"], #username'
    PASSWORD_INPUT = 'input[name="password"], #password'
    LOGIN_BUTTON = 'button[type="submit"], mwc-button'
    ERROR_MESSAGE = '.error-message, .login-error'

    async def navigate(self) -> None:
        """Navigate to login page."""
        await super().navigate("/")
        await self.page.wait_for_selector(self.USERNAME_INPUT, timeout=self.timeout)

    async def login(self, username: str, password: str) -> None:
        """Perform login with credentials."""
        await self.page.fill(self.USERNAME_INPUT, username)
        await self.page.fill(self.PASSWORD_INPUT, password)
        await self.page.click(self.LOGIN_BUTTON)

    async def wait_for_dashboard(self) -> None:
        """Wait for successful login and dashboard load."""
        await self.page.wait_for_url("**/lovelace/**", timeout=self.timeout)
        await self.wait_for_load()

    async def get_error_message(self) -> Optional[str]:
        """Get login error message if present."""
        error = self.page.locator(self.ERROR_MESSAGE)
        if await error.count() > 0:
            return await error.text_content()
        return None

    async def is_logged_in(self) -> bool:
        """Check if user is logged in."""
        return "lovelace" in self.page.url
```

#### Admin Panel

```python
# tests/e2e/pages/admin_panel.py

from playwright.async_api import Page, expect
from .base_page import BasePage


class AdminPanel(BasePage):
    """Page Object for Home Assistant admin/configuration panel."""

    # Selectors
    SETTINGS_MENU = 'a[href="/config"], ha-icon-button[data-panel="config"]'
    INTEGRATIONS_LINK = 'a[href*="integrations"]'
    INTEGRATION_CARD = '.integration-card, ha-card'
    CONFIGURE_BUTTON = 'mwc-button:has-text("Configure")'
    REBRAND_MANAGER_CARD = '[data-domain="ha_rebrand_manager"]'

    async def navigate_to_settings(self) -> None:
        """Navigate to settings page."""
        await super().navigate("/config")
        await self.wait_for_load()

    async def navigate_to_integrations(self) -> None:
        """Navigate to integrations page."""
        await super().navigate("/config/integrations")
        await self.page.wait_for_selector(self.INTEGRATION_CARD, timeout=self.timeout)

    async def find_integration(self, domain: str) -> bool:
        """Check if an integration is installed."""
        card = self.page.locator(f'[data-domain="{domain}"]')
        return await card.count() > 0

    async def open_rebrand_manager(self) -> None:
        """Open Ha Rebrand Manager configuration."""
        await self.page.click(self.REBRAND_MANAGER_CARD)
        await self.page.click(self.CONFIGURE_BUTTON)
        await self.wait_for_load()

    async def get_integration_state(self, domain: str) -> str:
        """Get the state of an integration (loaded, error, etc.)."""
        card = self.page.locator(f'[data-domain="{domain}"]')
        state = await card.get_attribute("data-state")
        return state or "unknown"
```

#### Sidebar

```python
# tests/e2e/pages/sidebar.py

from playwright.async_api import Page, expect
from .base_page import BasePage


class Sidebar(BasePage):
    """Page Object for Home Assistant sidebar component."""

    # Selectors
    SIDEBAR = 'ha-sidebar, .sidebar'
    MENU_ITEMS = '.menu-item, paper-icon-item'
    LOGO = '.logo, ha-sidebar img'
    TITLE = '.title, .sidebar-title'
    PANEL_LINK = 'a[data-panel="{panel}"]'

    async def is_visible(self) -> bool:
        """Check if sidebar is visible."""
        sidebar = self.page.locator(self.SIDEBAR)
        return await sidebar.is_visible()

    async def get_logo_src(self) -> Optional[str]:
        """Get the current logo image source."""
        logo = self.page.locator(self.LOGO)
        if await logo.count() > 0:
            return await logo.get_attribute("src")
        return None

    async def get_title(self) -> Optional[str]:
        """Get the sidebar title text."""
        title = self.page.locator(self.TITLE)
        if await title.count() > 0:
            return await title.text_content()
        return None

    async def navigate_to_panel(self, panel: str) -> None:
        """Click on a sidebar panel link."""
        link = self.page.locator(self.PANEL_LINK.format(panel=panel))
        await link.click()
        await self.wait_for_load()

    async def get_menu_items(self) -> list[str]:
        """Get list of all menu item labels."""
        items = self.page.locator(self.MENU_ITEMS)
        return await items.all_text_contents()

    async def verify_branding_applied(self, expected_color: str) -> bool:
        """Verify that custom branding colors are applied."""
        # Check CSS custom property or computed style
        color = await self.page.evaluate("""
            () => getComputedStyle(document.documentElement)
                .getPropertyValue('--primary-color')
        """)
        return expected_color.lower() in color.lower()
```

### Smoke Test

```python
# tests/e2e/test_smoke.py

import pytest


class TestE2EInfrastructure:
    """Smoke tests to verify E2E infrastructure works."""

    async def test_browser_launches(self, browser):
        """Verify browser can launch."""
        assert browser is not None
        assert browser.is_connected()

    async def test_page_loads(self, page):
        """Verify page can be created and navigate."""
        await page.goto("about:blank")
        assert page.url == "about:blank"

    async def test_ha_accessible(self, page):
        """Verify Home Assistant is accessible."""
        from conftest import HA_URL
        response = await page.goto(HA_URL)
        assert response.status == 200

    async def test_login_works(self, authenticated_page):
        """Verify login flow works."""
        assert "lovelace" in authenticated_page.url

    async def test_sidebar_visible(self, authenticated_page):
        """Verify sidebar is visible after login."""
        from pages.sidebar import Sidebar
        sidebar = Sidebar(authenticated_page)
        assert await sidebar.is_visible()
```

## Dependencies

- **Task 001**: Test directory structure and pytest configuration must exist
- **playwright**: `pip install playwright`
- **pytest-playwright**: `pip install pytest-playwright`
- **Browser binaries**: `playwright install chromium`

## Effort Estimate

- **Estimated Time**: 4-5 hours
- **Complexity**: Medium
- **Risk Level**: Medium (browser automation can be flaky)

## Definition of Done

1. All directories and files created as specified
2. Playwright fixtures work correctly
3. All Page Object Model classes implemented
4. Smoke tests pass successfully
5. Can run E2E tests with `pytest tests/e2e/ -v`
6. Documentation added to `tests/e2e/README.md`
7. `.env.example` created with required environment variables
8. Screenshots directory created for debugging
9. Code review completed
