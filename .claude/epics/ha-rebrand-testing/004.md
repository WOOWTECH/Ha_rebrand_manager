---
name: Security Unit Tests
status: open
created: 2026-02-02T10:02:04Z
updated: 2026-02-02T10:02:04Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: true
conflicts_with: []
---

# Task 004: Security Unit Tests

## Description

Implement comprehensive security-focused unit tests to validate input sanitization, XSS prevention, and file upload security mechanisms in the Ha Rebrand Manager component. These tests ensure that all user-supplied inputs are properly validated and sanitized before processing.

## Acceptance Criteria

- [ ] All `_escape_js_string()` tests pass with various XSS payloads
- [ ] All `_validate_color()` tests pass with malicious color inputs
- [ ] File upload validation tests cover type, size, and extension checks
- [ ] Test coverage for security functions reaches 100%
- [ ] No security vulnerabilities detected by static analysis

## Technical Details

### Test `_escape_js_string()` with XSS Payloads

```python
# tests/unit/test_security.py

class TestEscapeJsString:
    """Test JavaScript string escaping for XSS prevention."""

    @pytest.mark.parametrize("payload,expected_safe", [
        ("<script>alert('xss')</script>", True),
        ("'); alert('xss'); //", True),
        ('"; alert("xss"); //', True),
        ("</script><script>alert('xss')</script>", True),
        ("javascript:alert('xss')", True),
        ("<img src=x onerror=alert('xss')>", True),
        ("<svg onload=alert('xss')>", True),
        ("\\x3cscript\\x3ealert('xss')\\x3c/script\\x3e", True),
        ("\\u003cscript\\u003ealert('xss')\\u003c/script\\u003e", True),
    ])
    def test_xss_payloads_escaped(self, payload, expected_safe):
        """Verify XSS payloads are properly escaped."""
        result = _escape_js_string(payload)
        assert "<script>" not in result.lower()
        assert "javascript:" not in result.lower()
        assert "onerror=" not in result.lower()
        assert "onload=" not in result.lower()
```

### Test `_validate_color()` with Malicious Inputs

```python
class TestValidateColor:
    """Test color validation against injection attacks."""

    @pytest.mark.parametrize("malicious_input", [
        "red; background: url(javascript:alert('xss'))",
        "#000000; } body { background: red",
        "expression(alert('xss'))",
        "rgb(0,0,0); behavior: url(malicious.htc)",
        "#000</style><script>alert('xss')</script>",
        "url('data:text/html,<script>alert(1)</script>')",
    ])
    def test_css_injection_rejected(self, malicious_input):
        """Verify CSS injection attempts are rejected."""
        assert _validate_color(malicious_input) is False

    @pytest.mark.parametrize("valid_color", [
        "#ffffff",
        "#FFF",
        "rgb(255, 255, 255)",
        "rgba(255, 255, 255, 0.5)",
        "hsl(0, 0%, 100%)",
        "hsla(0, 0%, 100%, 0.5)",
        "red",
        "transparent",
    ])
    def test_valid_colors_accepted(self, valid_color):
        """Verify valid CSS colors are accepted."""
        assert _validate_color(valid_color) is True
```

### Test File Upload Validation

```python
class TestFileUploadValidation:
    """Test file upload security measures."""

    def test_reject_oversized_files(self):
        """Files exceeding size limit should be rejected."""
        large_file = b"x" * (MAX_FILE_SIZE + 1)
        with pytest.raises(ValidationError, match="File size exceeds"):
            validate_file_upload(large_file, "test.png")

    def test_reject_invalid_extensions(self):
        """Files with disallowed extensions should be rejected."""
        for ext in [".exe", ".php", ".sh", ".bat", ".cmd", ".js"]:
            with pytest.raises(ValidationError, match="Invalid file extension"):
                validate_file_upload(b"content", f"test{ext}")

    def test_reject_double_extensions(self):
        """Files with double extensions should be rejected."""
        with pytest.raises(ValidationError, match="Invalid file extension"):
            validate_file_upload(b"content", "test.png.php")

    def test_reject_mime_type_mismatch(self):
        """Files with mismatched MIME types should be rejected."""
        # PNG header but .jpg extension
        png_header = b"\x89PNG\r\n\x1a\n"
        with pytest.raises(ValidationError, match="MIME type mismatch"):
            validate_file_upload(png_header + b"content", "test.jpg")

    def test_accept_valid_images(self):
        """Valid image files should be accepted."""
        # Create minimal valid PNG
        valid_png = create_minimal_png()
        assert validate_file_upload(valid_png, "logo.png") is True

    def test_reject_svg_with_scripts(self):
        """SVG files containing scripts should be rejected."""
        malicious_svg = b'<svg><script>alert("xss")</script></svg>'
        with pytest.raises(ValidationError, match="SVG contains script"):
            validate_file_upload(malicious_svg, "icon.svg")
```

## Dependencies

- **Task 003**: Test fixtures and conftest.py must be created first
- **pytest**: Testing framework
- **pytest-asyncio**: For async test support

## Effort Estimate

- **Estimated Time**: 3-4 hours
- **Complexity**: Medium
- **Risk Level**: Low (testing existing security functions)

## Definition of Done

1. All security unit tests are implemented in `tests/unit/test_security.py`
2. Tests cover all edge cases and attack vectors documented above
3. All tests pass with `pytest tests/unit/test_security.py -v`
4. Test coverage for security functions is 100%
5. No false positives (valid inputs incorrectly rejected)
6. No false negatives (malicious inputs incorrectly accepted)
7. Tests are documented with clear descriptions
8. Code review completed
